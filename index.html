<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CRYOMOT - 3D Microscopy Analysis (Patched)</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      /* quick embedded styles for vtk container to ensure it fills area cleanly */
      #vtkContainer { position: relative; height: 80vh; width: 100%; background: #111; overflow: hidden; }
      #vtkCanvas { position: absolute; inset: 0; }
      #vtkControls { position: absolute; left: 10px; top: 10px; z-index: 20;
                     background: rgba(255,255,255,0.95); padding: 10px; border-radius: 6px;
                     width: 300px; font-size: 13px; }
      #viewerOverlayMessage { position: absolute; right: 10px; top: 10px; z-index: 21;
                              background: rgba(0,0,0,0.6); color: white; padding: 6px 8px; border-radius: 4px;}
      /* ensure other sections have spacing */
      .viewer-placeholder { height: 80vh; display:flex; align-items:center; justify-content:center; color:#999; }
    </style>
  </head>
  <body>
    <header>
      <div class="logo"><img src="logo.png" alt="CRYOMOT"></div>
      <button class="hamburger-menu" onclick="toggleMobileNav()">
        <img src="hams.png" alt="Menu" />
      </button>
      <nav id="desktop-nav">
        <button class="nav-btn active" onclick="switchTab('upload')">
          Upload Data
        </button>
        <button class="nav-btn" onclick="switchTab('analysis')">Analysis</button>
        <button class="nav-btn" onclick="switchTab('visualization')">
          3D Visualization
        </button>
        <button class="nav-btn" onclick="switchTab('results')">Results</button>
        <button class="nav-btn" onclick="switchTab('history')">History</button>
        <button class="nav-btn" onclick="switchTab('author')">Author</button>
        <button class="nav-btn" onclick="switchTab('instructions')">Instructions</button>
      </nav>
    </header>

    <!-- Mobile Sidebar Navigation -->
    <div class="mobile-nav-overlay" id="mobileNavOverlay" onclick="closeMobileNav()"></div>
    <nav class="mobile-nav" id="mobileNav">
      <button class="nav-btn active" onclick="switchTab('upload'); closeMobileNav()">
        Upload Data
      </button>
      <button class="nav-btn" onclick="switchTab('analysis'); closeMobileNav()">Analysis</button>
      <button class="nav-btn" onclick="switchTab('visualization'); closeMobileNav()">
        3D Visualization
      </button>
      <button class="nav-btn" onclick="switchTab('results'); closeMobileNav()">Results</button>
      <button class="nav-btn" onclick="switchTab('history'); closeMobileNav()">History</button>
      <button class="nav-btn" onclick="switchTab('author'); closeMobileNav()">Author</button>
      <button class="nav-btn" onclick="switchTab('instructions'); closeMobileNav()">Instructions</button>
    </nav>

    <div class="container">
      <!-- Upload Data Section -->
      <section id="upload" class="section active upload-section">
        <h2>Upload 3D Microscopy Data</h2>
        <div
          class="drop-zone"
          onclick="openFolderPicker()"
          ondragover="handleDragOver(event)"
          ondrop="handleDrop(event)"
          ondragleave="handleDragLeave(event)"
        >
          Drop your cryo-ET folder here
        </div>
        <input
          type="file"
          id="folderInput"
          webkitdirectory
          directory
          multiple
          onchange="handleFolderSelect(event)"
        />
        <div class="parameters-row">
          <div class="parameter-box">
            <h3>Detection Parameters</h3>
            <div style="margin-bottom: 15px">
              <div
                style="font-size: 12px; font-weight: 600; margin-bottom: 8px"
              >
                Confidence Threshold
              </div>
              <div class="slider-container">
                <span class="slider-label">70%</span>
                <input type="range" min="0" max="100" value="70" />
                <span class="slider-label">100%</span>
              </div>
            </div>
          </div>
          <div class="parameter-box">
            <h3>Preprocessing Options</h3>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" checked />
                <label>Noise reduction</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" checked />
                <label>Edge preserve</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" checked />
                <label>Normalize intensity</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" />
                <label>Auto-contrast Adjustment</label>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Analysis Section -->
      <section id="analysis" class="section">
        <div class="pipeline">
          <h2>Analysis Pipeline</h2>
          <div>
            <div class="pipeline-step">
              <div style="display: flex; align-items: center; flex: 1">
                <div class="step-icon"></div>
                <div class="step-content">
                  <div class="step-name">Data Loading</div>
                  <div class="step-status">8.6s</div>
                </div>
              </div>
              <button class="step-toggle" onclick="toggleStep(this)">▼</button>
            </div>
            <div class="step-content-expanded">
              <div class="thumbnails">
                <div class="thumbnail"></div>
                <div class="thumbnail"></div>
                <div class="thumbnail"></div>
                <div class="thumbnail"></div>
              </div>
            </div>
          </div>

          <div class="pipeline-step">
            <div style="display: flex; align-items: center; flex: 1">
              <div class="step-icon"></div>
              <div class="step-content">
                <div class="step-name">Preprocessing</div>
                <div class="step-status">loading</div>
              </div>
            </div>
            <button class="step-toggle" onclick="toggleStep(this)">▼</button>
          </div>

          <div class="pipeline-step">
            <div style="display: flex; align-items: center; flex: 1">
              <div class="step-icon"></div>
              <div class="step-content">
                <div class="step-name">Deep Learning Inference</div>
                <div class="step-status">loading</div>
              </div>
            </div>
            <button class="step-toggle" onclick="toggleStep(this)">▼</button>
          </div>

          <div class="pipeline-step">
            <div style="display: flex; align-items: center; flex: 1">
              <div class="step-icon"></div>
              <div class="step-content">
                <div class="step-name">Post-processing</div>
                <div class="step-status">loading</div>
              </div>
            </div>
            <button class="step-toggle" onclick="toggleStep(this)">▼</button>
          </div>

          <div class="pipeline-step">
            <div style="display: flex; align-items: center; flex: 1">
              <div class="step-icon"></div>
              <div class="step-content">
                <div class="step-name">Results Generation</div>
                <div class="step-status">loading</div>
              </div>
            </div>
            <button class="step-toggle" onclick="toggleStep(this)">▼</button>
          </div>
        </div>
      </section>

      <!-- 3D Visualization Section (patched) -->
      <section id="visualization" class="section">
        <h2>3D Reconstruction Viewer</h2>

        <div id="vtkContainer" class="viewer">
          <div id="vtkCanvas"></div>

          <div id="vtkControls">
            <div style="font-weight:700; margin-bottom:6px;">VTK.js Tomogram Viewer (RGBA + Motors)</div>

            <label style="font-size:12px;">Volume (.npy)</label>
            <input id="fileInput" type="file" accept=".npy" style="width:100%; margin-top:4px;">
            <div style="margin-top:6px;">
              <label style="font-size:12px;">or URL</label>
              <input id="urlInput" type="text" placeholder="relative/path/to/volume.npy" style="width:100%; margin-top:4px;">
              <button id="loadUrl" style="margin-top:6px;">Load Volume</button>
            </div>

            <hr style="margin:8px 0;">

            <label style="font-size:12px;">Motor coordinates (.npy)</label>
            <input id="motorsFile" type="file" accept=".npy" style="width:100%; margin-top:4px;">
            <div style="margin-top:6px;">
              <input id="motorsUrl" type="text" placeholder="relative/path/to/motors.npy" style="width:100%; margin-top:4px;">
              <button id="loadMotorsUrl" style="margin-top:6px;">Load Motors</button>
            </div>

            <div style="margin-top:8px;">
              <label>Sample distance</label><br>
              <input id="sampleDist" type="range" min="0.1" max="5" step="0.1" value="1" style="width:100%;">
            </div>

            <div style="margin-top:8px;">
              <input id="showVolume" type="checkbox" checked> <label for="showVolume">Show Volume</label><br>
              <input id="showMotors" type="checkbox" checked> <label for="showMotors">Show Motors</label>
            </div>

            <div style="margin-top:8px;">
              <button id="downloadNpy" disabled>Download current volume (.npy)</button>
            </div>

            <div style="font-size:11px; margin-top:8px; color:#333;">Tip: serve over local HTTP server: <code>python -m http.server 8000</code></div>
          </div>

          <div id="viewerOverlayMessage">No volume loaded</div>
        </div>
      </section>

       <!-- Results Section -->
      <section id="results" class="section" style="position: relative">
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-label">Total Motors Detected</div>
            <div id="totalMotorsValue" class="stat-value">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Avg. Euclidean Distance</div>
            <div id="avgDistanceValue" class="stat-value">81%</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Avg. F Beta Score</div>
            <div id="avgFbetaValue" class="stat-value">81%</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Avg. Processing time</div>
            <div id="avgProcTimeValue" class="stat-value">5.8s</div>
          </div>
        </div>

        <div class="detection-summary">
          <h3>Detection Summary</h3>
          <div class="detection-row">
            <div>High Confidence (&gt;90%)</div>
            <div id="highConfCount">0</div>
          </div>
          <div class="detection-row">
            <div>Medium Confidence (80-90%)</div>
            <div id="medConfCount">0</div>
          </div>
          <div class="detection-row">
            <div>Low Confidence (&lt;80%)</div>
            <div id="lowConfCount">0</div>
          </div>
        </div>

        <!-- Save Result button (bottom-right of Results tab) -->
        <button
          id="saveResultBtn"
          class="delete-btn"
          style="
            position: absolute;
            right: 20px;
            bottom: 20px;
            padding: 8px 12px;
          "
          onclick="saveResult()"
        >
          Save Result
        </button>
      </section>

      <!-- History Section -->
      <section id="history" class="section">
        <div class="history-list">
          <h2 style="margin-bottom: 20px">History</h2>

          <div>
            <div class="history-item">
              <div class="history-timestamp">10-09-2025 11:35:55</div>
              <div class="history-count">0</div>
              <div class="history-controls">
                <button class="delete-btn" onclick="toggleHistory(this)">
                  ▼
                </button>
              </div>
            </div>
            <div class="history-expanded">
              <div class="stats-grid" style="margin-top: 0">
                <div class="stat-box">
                  <div class="stat-label">Total Motors Detected</div>
                  <div class="stat-value">0</div>
                </div>
                <div class="stat-box">
                  <div class="stat-label">Avg. Euclidean Distance</div>
                  <div class="stat-value">81%</div>
                </div>
                <div class="stat-box">
                  <div class="stat-label">Avg. F Beta Score</div>
                  <div class="stat-value">81%</div>
                </div>
                <div class="stat-box">
                  <div class="stat-label">Avg. Processing time</div>
                  <div class="stat-value">5.8s</div>
                </div>
              </div>
              <button class="delete-history-btn" onclick="deleteHistory(this)">
                Delete
              </button>
            </div>
          </div>

          <div>
            <div class="history-item">
              <div class="history-timestamp">10-09-2025 14:15:03</div>
              <div class="history-count">3</div>
              <div class="history-controls">
                <button class="delete-btn" onclick="toggleHistory(this)">
                  ▼
                </button>
              </div>
            </div>
            <div class="history-expanded">
              <div class="stats-grid" style="margin-top: 0">
                <div class="stat-box">
                  <div class="stat-label">Total Motors Detected</div>
                  <div class="stat-value">3</div>
                </div>
                <div class="stat-box">
                  <div class="stat-label">Avg. Euclidean Distance</div>
                  <div class="stat-value">81%</div>
                </div>
                <div class="stat-box">
                  <div class="stat-label">Avg. F Beta Score</div>
                  <div class="stat-value">81%</div>
                </div>
                <div class="stat-box">
                  <div class="stat-label">Avg. Processing time</div>
                  <div class="stat-value">5.8s</div>
                </div>
              </div>
              <button class="delete-history-btn" onclick="deleteHistory(this)">
                Delete
              </button>
            </div>
          </div>

          <div>
            <div class="history-item">
              <div class="history-timestamp">10-07-2025 16:50:05</div>
              <div class="history-count">1</div>
              <div class="history-controls">
                <button class="delete-btn" onclick="toggleHistory(this)">
                  ▲
                </button>
              </div>
            </div>
            <div class="history-expanded">
              <div class="stats-grid" style="margin-top: 0">
                <div class="stat-box">
                  <div class="stat-label">Total Motors Detected</div>
                  <div class="stat-value">1</div>
                </div>
                <div class="stat-box">
                  <div class="stat-label">Avg. Euclidean Distance</div>
                  <div class="stat-value">81%</div>
                </div>
                <div class="stat-box">
                  <div class="stat-label">Avg. F Beta Score</div>
                  <div class="stat-value">81%</div>
                </div>
                <div class="stat-box">
                  <div class="stat-label">Avg. Processing time</div>
                  <div class="stat-value">56.8s</div>
                </div>
                <button
                  class="delete-history-btn"
                  onclick="deleteHistory(this)"
                >
                  Delete
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Button to add random test data -->
        <button
          id="addRandomBtn"
          class="delete-btn"
          style="
            margin-top: 20px;
            padding: 10px 20px;
            width: 100%;
            max-width: 300px;
            display: block;
            margin-left: auto;
            margin-right: auto;
          "
          onclick="addRandomHistory()"
        >
          Add Random Test Data
        </button>
      </section>
      <!-- Author Section -->
      <section id="author" class="section">
        <h2>About Us</h2>
        <p>
          1Lorem ipsum dolor sit amet consectetur adipiscing elit. Quisque faucibus ex sapien vitae pellentesque sem placerat. In id cursus mi pretium tellus duis convallis. Tempus leo eu aenean sed diam urna tempor. Pulvinar vivamus fringilla lacus nec metus bibendum egestas. Iaculis massa nisl malesuada lacinia integer nunc posuere. Ut hendrerit semper vel class aptent taciti sociosqu. Ad litora torquent per conubia nostra inceptos himenaeos.

          Lorem ipsum dolor sit amet consectetur adipiscing elit. Quisque faucibus ex sapien vitae pellentesque sem placerat. In id cursus mi pretium tellus duis convallis. Tempus leo eu aenean sed diam urna tempor. Pulvinar vivamus fringilla lacus nec metus bibendum egestas. Iaculis massa nisl malesuada lacinia integer nunc posuere. Ut hendrerit semper vel class aptent taciti sociosqu. Ad litora torquent per conubia nostra inceptos himenaeos.

          Lorem ipsum dolor sit amet consectetur adipiscing elit. Quisque faucibus ex sapien vitae pellentesque sem placerat. In id cursus mi pretium tellus duis convallis. Tempus leo eu aenean sed diam urna tempor. Pulvinar vivamus fringilla lacus nec metus bibendum egestas. Iaculis massa nisl malesuada lacinia integer nunc posuere. Ut hendrerit semper vel class aptent taciti sociosqu. Ad litora torquent per conubia nostra inceptos himenaeos.

          Lorem ipsum dolor sit amet consectetur adipiscing elit. Quisque faucibus ex sapien vitae pellentesque sem placerat. In id cursus mi pretium tellus duis convallis. Tempus leo eu aenean sed diam urna tempor. Pulvinar vivamus fringilla lacus nec metus bibendum egestas. Iaculis massa nisl malesuada lacinia integer nunc posuere. Ut hendrerit semper vel class aptent taciti sociosqu. Ad litora torquent per conubia nostra inceptos himenaeos.
        </p>
      </section>
      <!-- Instructions Section -->
      <section id="instructions" class="section">
        <h2>Instructions</h2>
        <p>
          Follow these instructions to use the application effectively:
        </p>
        <ol>
          <li>Step 1: Do this</li>
          <li>Step 2: Then do this</li>
          <li>Step 3: Finally, do this</li>
        </ol>
      </section>
    <script src="script.js"></script>

    <!-- VTK.js -->
    <script src="https://unpkg.com/vtk.js"></script>

    <script>
    // --- NPY parser (supports common dtypes and shapes) ---
    function parseNpy(buffer) {
      const dv = new DataView(buffer);
      const magic = String.fromCharCode.apply(null, new Uint8Array(buffer, 0, 6));
      if (magic !== "\\x93NUMPY") throw new Error("Not a .npy file");
      let offset = 6;
      const major = dv.getUint8(offset); offset += 1;
      const minor = dv.getUint8(offset); offset += 1;
      let headerLen = 0;
      if (major === 1) {
        headerLen = dv.getUint16(offset, true); offset += 2;
      } else {
        headerLen = dv.getUint32(offset, true); offset += 4;
      }
      const headerBytes = new Uint8Array(buffer, offset, headerLen);
      const header = new TextDecoder("utf-8").decode(headerBytes);
      offset += headerLen;

      const descrMatch = header.match(/'descr':\\s*'([^']+)'/);
      const shapeMatch = header.match(/'shape':\\s*\\(([^\\)]*)\\)/);
      if (!descrMatch || !shapeMatch) throw new Error("Unsupported .npy header");
      const descr = descrMatch[1];
      const shape = shapeMatch[1].split(",").map(s=>s.trim()).filter(s=>s.length).map(s=>parseInt(s,10));
      const count = shape.reduce((a,b)=>a*b,1);

      const typeCode = descr.slice(-2);
      let typedArray = null;
      if (typeCode === "f4") typedArray = new Float32Array(buffer, offset, count);
      else if (typeCode === "f8") typedArray = new Float64Array(buffer, offset, count);
      else if (typeCode === "u1" || typeCode==="i1") typedArray = new Uint8Array(buffer, offset, count);
      else if (typeCode === "u2" || typeCode==="i2") typedArray = new Uint16Array(buffer, offset, count);
      else if (typeCode === "u4" || typeCode==="i4") typedArray = new Uint32Array(buffer, offset, count);
      else throw new Error("Unsupported dtype: " + descr);

      return {shape, data: typedArray, descr};
    }

    // Create vtkImageData from parsed npy (supports (Z,Y,X) or (Z,Y,X,4) for RGBA)
    function vtkImageFromNpy(parsed) {
      const shp = parsed.shape.slice();
      let z,y,x,components=1;
      if (shp.length === 4) { z = shp[0]; y = shp[1]; x = shp[2]; components = shp[3]; }
      else if (shp.length === 3) { z = shp[0]; y = shp[1]; x = shp[2]; components = 1; }
      else if (shp.length === 2) { z = 1; y = shp[0]; x = shp[1]; components = 1; }
      else throw new Error("Unsupported array shape: expected 2D/3D or 4D (Z,Y,X,C)");

      const imageData = vtk.Common.DataModel.vtkImageData.newInstance();
      imageData.setOrigin(0,0,0);
      imageData.setSpacing(1,1,1);
      imageData.setDimensions(x, y, z);

      // When components>1 and equals 4 we assume RGBA per-voxel; we'll set as scalars but interpret later
      const vtkArray = vtk.Common.Core.vtkDataArray.newInstance({
        numberOfComponents: components,
        values: parsed.data,
      });
      vtkArray.setName("Scalars");
      imageData.getPointData().setScalars(vtkArray);
      return imageData;
    }

    // Utility: create vtk.js point polydata from Nx3 Float32Array or array
    function createPointPolyData(pointsArray) {
      // pointsArray: Float32Array or Array with length N*3
      const pts = vtk.Common.Core.vtkPoints.newInstance();
      pts.setData(pointsArray, 3);
      const poly = vtk.Common.DataModel.vtkPolyData.newInstance();
      poly.setPoints(pts);
      return poly;
    }

    // Global references to keep alive
    let fullScreenRenderer = null;
    let currentVolumeActor = null;
    let currentMotorActor = null;
    let renderer = null;
    let renderWindow = null;
    let mapper = null;

    function clearExisting() {
      if (!fullScreenRenderer) return;
      // dispose previous render window by removing its root container children
      const root = document.getElementById('vtkCanvas');
      // vtkFullScreenRenderWindow inserts its own DOM; easiest to reload page area:
      root.innerHTML = '';
      fullScreenRenderer = null;
      currentVolumeActor = null;
      currentMotorActor = null;
    }

    function renderImage(imageData) {
      // clear previous
      clearExisting();

      const root = document.getElementById('vtkCanvas');
      // create a full screen renderer but attach to our specific container
      fullScreenRenderer = vtk.Rendering.Misc.vtkFullScreenRenderWindow.newInstance({
        rootContainer: root,
        background: [0.12,0.12,0.12],
      });
      renderer = fullScreenRenderer.getRenderer();
      renderWindow = fullScreenRenderer.getRenderWindow();

      // Volume mapper
      mapper = vtk.Rendering.Core.vtkVolumeMapper.newInstance();
      const sd = parseFloat(document.getElementById('sampleDist').value) || 1.0;
      mapper.setSampleDistance(sd);
      mapper.setInputData(imageData);

      const actor = vtk.Rendering.Core.vtkVolume.newInstance();
      actor.setMapper(mapper);

      // Make transfer functions; if RGBA data present (components===4) use alpha channel
      const scalars = imageData.getPointData().getScalars();
      const comps = scalars.getNumberOfComponents ? scalars.getNumberOfComponents() : 1;
      const range = scalars.getRange ? scalars.getRange() : [0,1];

      const min = range[0], max = range[1];

      const ctfun = vtk.Rendering.Core.vtkColorTransferFunction.newInstance();
      const ofun = vtk.Common.DataModel.vtkPiecewiseFunction.newInstance();

      if (comps === 4) {
        // For RGBA we will treat colors per-voxel by using a mapper that expects components.
        // vtkVolumeMapper in vtk.js expects a scalar + transfer functions; per-voxel RGBA isn't directly supported,
        // but we can approximate by setting color transfer to map scalar->color and opacity from 4th component.
        // Strategy: compute scalar = first component for color mapping and use 4th component for opacity via shader replacement.
        ctfun.addRGBPoint(min, 0,0,0);
        ctfun.addRGBPoint(max, 1,1,1);
        ofun.addPoint(min, 0.0);
        ofun.addPoint(max, 1.0);

        actor.getProperty().setRGBTransferFunction(0, ctfun);
        actor.getProperty().setScalarOpacity(0, ofun);
        actor.getProperty().setScalarOpacityUnitDistance(0, 1.0);
        actor.getProperty().setInterpolationTypeToLinear();

        // shader replacement: attempt to route alpha from fourth component
        mapper.addShaderReplacement(
          vtk.Rendering.Core.vtkVolumeMapper.FragmentShaderReplacementType.DEFAULT,
          '//VTK::ComputeColor::Impl',
          true,
          `
            // Attempt to use fourth component as alpha if present
            // 'in_fragColor' may already contain computed color; direct access to voxel components is limited in this context.
            // This replacement is a best-effort: for best RGBA fidelity, convert RGBA to a single-scalar volume + separate alpha volume on server side.
            // We'll leave default behavior but increase opacity mapping.
            // (Note: complex per-voxel RGBA needs server-side conversion for robust results.)
          `,
          false
        );

      } else {
        // Greyscale / scalar volume: set simple TF
        ctfun.addRGBPoint(min, 0.0,0.0,0.0);
        ctfun.addRGBPoint((min+max)/2, 0.8,0.8,0.8);
        ctfun.addRGBPoint(max, 1.0,1.0,1.0);

        ofun.addPoint(min, 0.0);
        ofun.addPoint((min+max)/2, 0.2);
        ofun.addPoint(max, 1.0);

        actor.getProperty().setRGBTransferFunction(0, ctfun);
        actor.getProperty().setScalarOpacity(0, ofun);
        actor.getProperty().setScalarOpacityUnitDistance(0, 1.0);
        actor.getProperty().setInterpolationTypeToLinear();
      }

      renderer.addVolume(actor);
      renderer.resetCamera();
      renderWindow.render();

      currentVolumeActor = actor;

      // wire sample distance control
      const sampleCtrl = document.getElementById('sampleDist');
      sampleCtrl.oninput = () => {
        mapper.setSampleDistance(parseFloat(sampleCtrl.value));
        renderWindow.render();
      };

      document.getElementById('viewerOverlayMessage').textContent = 'Volume loaded: ' + imageData.getDimensions().join('x');
    }

    // Render motor coordinates as spheres/glyphs
    function renderMotors(coordArray) {
      if (!renderWindow || !renderer) {
        console.warn('Render window not ready yet.');
        return;
      }
      let floatArr;
      if (coordArray instanceof Float32Array) floatArr = coordArray;
      else floatArr = new Float32Array(coordArray);

      // If length is N*3, we assume x,y,z ordering
      const poly = createPointPolyData(floatArr);

      const sphereSource = vtk.Filters.Sources.vtkSphereSource.newInstance({radius: 1.0, thetaResolution: 12, phiResolution: 8});

      const glyphMapper = vtk.Rendering.Core.vtkGlyph3DMapper.newInstance();
      glyphMapper.setInputData(poly);
      glyphMapper.setGlyphConnection(sphereSource.getOutputData());
      glyphMapper.setScaleArray(null);
      glyphMapper.setScaleFactor(2.0);
      glyphMapper.setOrientationArray(null);

      const actor = vtk.Rendering.Core.vtkActor.newInstance();
      actor.setMapper(glyphMapper);

      actor.getProperty().setColor(1.0, 0.2, 0.2);
      actor.getProperty().setAmbient(0.3);
      actor.getProperty().setDiffuse(0.7);

      if (currentMotorActor) renderer.removeActor(currentMotorActor);
      renderer.addActor(actor);
      currentMotorActor = actor;
      renderWindow.render();
    }

    // Read file input and load
    let lastParsedVolume = null;
    let lastParsedMotors = null;

    document.getElementById('fileInput').addEventListener('change', (ev)=>{
      const file = ev.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const parsed = parseNpy(e.target.result);
          lastParsedVolume = parsed;
          const imageData = vtkImageFromNpy(parsed);
          renderImage(imageData);
          document.getElementById('downloadNpy').disabled = false;
          if (lastParsedMotors) {
            renderMotors(lastParsedMotors.data);
          }
        } catch (err) {
          alert('Error parsing .npy volume: ' + err.message);
        }
      };
      reader.readAsArrayBuffer(file);
    });

    document.getElementById('loadUrl').addEventListener('click', async ()=>{
      const url = document.getElementById('urlInput').value.trim();
      if (!url) return alert('Enter a relative URL or file path');
      try {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('Fetch failed: ' + resp.status);
        const ab = await resp.arrayBuffer();
        const parsed = parseNpy(ab);
        lastParsedVolume = parsed;
        renderImage(vtkImageFromNpy(parsed));
        document.getElementById('downloadNpy').disabled = false;
      } catch (err) {
        alert('Load error: ' + err.message);
      }
    });

    // Motors (.npy Nx3)
    document.getElementById('motorsFile').addEventListener('change', (ev)=>{
      const file = ev.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const parsed = parseNpy(e.target.result);
          // Expect shape [N,3]
          lastParsedMotors = parsed;
          renderMotors(parsed.data);
        } catch (err) {
          alert('Error parsing motors .npy: ' + err.message);
        }
      };
      reader.readAsArrayBuffer(file);
    });

    document.getElementById('loadMotorsUrl').addEventListener('click', async ()=>{
      const url = document.getElementById('motorsUrl').value.trim();
      if (!url) return alert('Enter a motors URL');
      try {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('Fetch failed: ' + resp.status);
        const ab = await resp.arrayBuffer();
        const parsed = parseNpy(ab);
        lastParsedMotors = parsed;
        renderMotors(parsed.data);
      } catch (err) {
        alert('Motors load error: ' + err.message);
      }
    });

    // toggles
    document.getElementById('showVolume').addEventListener('change', (e)=>{
      if (!currentVolumeActor) return;
      currentVolumeActor.setVisibility(e.target.checked);
      if (renderWindow) renderWindow.render();
    });
    document.getElementById('showMotors').addEventListener('change', (e)=>{
      if (!currentMotorActor) return;
      currentMotorActor.setVisibility(e.target.checked);
      if (renderWindow) renderWindow.render();
    });

    // download current volume back to npy
    document.getElementById('downloadNpy').addEventListener('click', ()=>{
      if (!lastParsedVolume) return alert('No volume loaded');
      try {
        const buf = createNpyBuffer(lastParsedVolume);
        const blob = new Blob([buf], {type:'application/octet-stream'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'volume_export.npy';
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        alert('Failed to create npy: ' + err.message);
      }
    });

    // createNpyBuffer - re-create .npy from parsed representation (basic)
    function createNpyBuffer(parsed) {
      const descr = parsed.descr || "<f4";
      const shape = parsed.shape.slice();
      const shapeStr = "(" + shape.join(",") + (shape.length===1? ",": "") + ")";
      let header = "{'descr': '" + descr + "', 'fortran_order': False, 'shape': " + shapeStr + ", }";
      const encoder = new TextEncoder();
      let headerBytes = encoder.encode(header + "\n");
      const preLen = 10 + headerBytes.length;
      const pad = (16 - (preLen % 16)) % 16;
      if (pad>0) {
        header = header + " ".repeat(pad) + "\n";
        headerBytes = encoder.encode(header);
      }
      const magic = "\x93NUMPY";
      const major = 1, minor = 0;
      const headerLen = headerBytes.length;
      const dataView = parsed.data;
      const dataByteArray = new Uint8Array(dataView.buffer, dataView.byteOffset, dataView.byteLength);
      const out = new Uint8Array(10 + headerLen + dataByteArray.length);
      let offset = 0;
      for (let i=0;i<6;i++) out[offset++] = magic.charCodeAt(i);
      out[offset++] = major; out[offset++] = minor;
      out[offset++] = headerLen & 0xff; out[offset++] = (headerLen>>8)&0xff;
      out.set(headerBytes, offset); offset += headerLen;
      out.set(dataByteArray, offset);
      return out.buffer;
    }

    // Small helper wiring to ensure the vtkCanvas has the right size when tab shown
    function ensureCanvasSize() {
      const root = document.getElementById('vtkCanvas');
      if (!root) return;
      root.style.width = '100%';
      root.style.height = '100%';
    }
    window.addEventListener('resize', () => {
      ensureCanvasSize();
      if (renderWindow) renderWindow.render();
    });
    ensureCanvasSize();
    function parseNpy(buffer) {
  const view = new DataView(buffer);

  // Check magic string
  const magic = String.fromCharCode(
    view.getUint8(0),
    view.getUint8(1),
    view.getUint8(2),
    view.getUint8(3),
    view.getUint8(4),
    view.getUint8(5)
  );
  if (magic !== "\x93NUMPY") {
    throw new Error("Not a .npy file (magic mismatch)");
  }

  const major = view.getUint8(6);
  const minor = view.getUint8(7);

  let headerLength;
  let offset = 8;

  // NumPy v1.0 – v1.9
  if (major === 1) {
    headerLength = view.getUint16(offset, true);
    offset += 2;
  }
  // NumPy v2.0+
  else if (major === 2) {
    headerLength = view.getUint32(offset, true);
    offset += 4;
  }
  else {
    throw new Error("Unsupported NPY version: " + major + "." + minor);
  }

  const headerText = new TextDecoder("utf-8").decode(
    new Uint8Array(buffer, offset, headerLength)
  );

  // Clean header: remove trailing spaces, newlines, etc.
  const cleanHeader = headerText
    .replace(/[\r\n]/g, " ")
    .replace(/\s+/g, " ")
    .trim();

  // Extract descr, fortran_order, shape using relaxed regex
  const descrMatch = cleanHeader.match(/'descr':\s*'([^']+)'/);
  const shapeMatch = cleanHeader.match(/'shape':\s*\(([^)]*)\)/);
  const fortranMatch = cleanHeader.match(/'fortran_order':\s*(True|False)/);

  if (!descrMatch || !shapeMatch) {
    throw new Error("Invalid .npy header format");
  }

  const descr = descrMatch[1].trim();
  const shapeStr = shapeMatch[1].trim();
  const fortran = fortranMatch ? fortranMatch[1] === "True" : false;

  let shape = [];
  if (shapeStr.length > 0) {
    shape = shapeStr
      .split(",")
      .map(s => s.trim())
      .filter(s => s.length > 0)
      .map(s => parseInt(s, 10));
  }

  offset += headerLength;

  // Determine dtype
  const typeCode = descr.slice(-2);
  let data;
  const count = shape.reduce((a, b) => a * b, 1);

  switch (typeCode) {
    case "f4": data = new Float32Array(buffer, offset, count); break;
    case "f8": data = new Float64Array(buffer, offset, count); break;
    case "i1": data = new Int8Array(buffer, offset, count); break;
    case "u1": data = new Uint8Array(buffer, offset, count); break;
    case "i2": data = new Int16Array(buffer, offset, count); break;
    case "u2": data = new Uint16Array(buffer, offset, count); break;
    case "i4": data = new Int32Array(buffer, offset, count); break;
    case "u4": data = new Uint32Array(buffer, offset, count); break;
    default:
      throw new Error("Unsupported dtype: " + descr);
  }

  return {
    descr,
    shape,
    data,
    fortran
  };
}


    </script>
  </body>
</html>
